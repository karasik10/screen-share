<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–∫—Ä–∞–Ω & –ó–≤—É–∫ (P2P)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        #controls { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; text-align: center; backdrop-filter: blur(5px); }
        
        button { padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; margin: 5px; }
        .btn-start { background: #27ae60; color: white; }
        .btn-copy { background: #2980b9; color: white; display: none; }
        .btn-stop { background: #c0392b; color: white; display: none; }
        button:hover { filter: brightness(1.1); transform: scale(1.05); }

        video { width: 100%; height: 100%; object-fit: contain; background: #111; }
        
        #status { font-size: 14px; color: #ccc; margin-top: 5px; }
        .link-box { margin-top: 10px; display: none; }
        input { background: #333; border: 1px solid #555; color: #fff; padding: 5px; border-radius: 4px; width: 250px; text-align: center; }
    </style>
</head>
<body>

    <div id="controls">
        <div id="ui-start">
            <h3>üî¥ –ó–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏</h3>
            <button class="btn-start" onclick="startStream()">–ù–∞—á–∞—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é</button>
        </div>

        <div id="ui-stream" style="display:none;">
            <div id="status">–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞</div>
            <div class="link-box" style="display:block;">
                <input type="text" id="share-link" readonly>
                <button class="btn-copy" style="display:inline-block;" onclick="copyLink()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
        </div>

        <div id="ui-viewer" style="display:none;">
            <h3>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä</h3>
            <p id="view-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å—Ç—Ä–∏–º—É...</p>
        </div>
    </div>

    <video id="video-player" autoplay playsinline controls></video>

    <script>
        // –ò—â–µ–º ID –≤ —Å—Å—ã–ª–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, site.com/?id=qwerty)
        const urlParams = new URLSearchParams(window.location.search);
        const targetPeerId = urlParams.get('id');

        const videoElem = document.getElementById('video-player');
        let peer;
        let localStream;

        // --- –õ–û–ì–ò–ö–ê: –ï–°–õ–ò –ï–°–¢–¨ ID –í –°–°–´–õ–ö–ï, –ó–ù–ê–ß–ò–¢ –ú–´ –ó–†–ò–¢–ï–õ–¨ ---
        if (targetPeerId) {
            document.getElementById('ui-start').style.display = 'none';
            document.getElementById('ui-viewer').style.display = 'block';
            
            initViewer(targetPeerId);
        }

        // --- –õ–û–ì–ò–ö–ê –•–û–°–¢–ê (–°–¢–†–ò–ú–ï–†–ê) ---
        async function startStream() {
            try {
                // –ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞ + —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∑–≤—É–∫–∞
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always", frameRate: 60, height: 1080 },
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false // –í–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –º—É–∑—ã–∫–∏/–∏–≥—Ä—ã
                    }
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∏–º —Å–∞–º–æ–º—É —Å–µ–±–µ (–Ω–æ –±–µ–∑ –∑–≤—É–∫–∞, —á—Ç–æ–±—ã –Ω–µ —Ñ–æ–Ω–∏–ª–æ)
                videoElem.srcObject = localStream;
                videoElem.muted = true; 

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PeerJS
                peer = new Peer();

                peer.on('open', (id) => {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –¥—Ä—É–≥–∞
                    const shareUrl = window.location.origin + window.location.pathname + '?id=' + id;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    document.getElementById('ui-start').style.display = 'none';
                    document.getElementById('ui-stream').style.display = 'block';
                    document.getElementById('share-link').value = shareUrl;
                    document.getElementById('status').innerText = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥—Ä—É–≥–∞...";
                });

                // –ö–æ–≥–¥–∞ –¥—Ä—É–≥ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
                peer.on('call', (call) => {
                    call.answer(localStream);
                    document.getElementById('status').innerText = "üî¥ –î—Ä—É–≥ —Å–º–æ—Ç—Ä–∏—Ç —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é!";
                });

                // –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–ª –¥–æ—Å—Ç—É–ø –∫ —ç–∫—Ä–∞–Ω—É –∫–Ω–æ–ø–∫–æ–π –±—Ä–∞—É–∑–µ—Ä–∞
                localStream.getVideoTracks()[0].onended = () => {
                    alert("–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
                    location.reload();
                };

            } catch (err) {
                console.error(err);
                alert("–û—à–∏–±–∫–∞: " + err.message);
            }
        }

        function copyLink() {
            const copyText = document.getElementById("share-link");
            copyText.select();
            document.execCommand("copy");
            alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å –µ—ë –¥—Ä—É–≥—É.");
        }

        // --- –õ–û–ì–ò–ö–ê –ó–†–ò–¢–ï–õ–Ø ---
        function initViewer(hostId) {
            peer = new Peer();

            peer.on('open', () => {
                document.getElementById('view-status').innerText = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–æ–º...";
                connectToHost(hostId);
            });

            peer.on('error', (err) => {
                document.getElementById('view-status').innerText = "–û—à–∏–±–∫–∞: " + err.type;
            });
        }

        function connectToHost(hostId) {
            // –ó–≤–æ–Ω–∏–º —Ö–æ—Å—Ç—É
            const call = peer.call(hostId, new MediaStream()); // –®–ª–µ–º –ø—É—Å—Ç—ã—à–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª

            call.on('stream', (remoteStream) => {
                document.getElementById('controls').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —É –∑—Ä–∏—Ç–µ–ª—è
                videoElem.srcObject = remoteStream;
                videoElem.muted = false; // –í–∫–ª—é—á–∞–µ–º –∑–≤—É–∫
                videoElem.play().catch(e => console.log("–ù—É–∂–µ–Ω –∫–ª–∏–∫ –¥–ª—è –∑–≤—É–∫–∞"));
            });

            call.on('close', () => {
                alert("–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
            });
        }
    </script>
</body>
</html>
