<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–∫—Ä–∞–Ω & –ó–≤—É–∫ (Enhanced)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        #controls { position: absolute; top: 10px; z-index: 10; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #333; max-width: 90%; }
        
        button { padding: 12px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; margin: 5px; }
        .btn-start { background: #27ae60; color: white; }
        .btn-copy { background: #2980b9; color: white; }
        .btn-play { background: #e67e22; color: white; display: none; } /* –ö–Ω–æ–ø–∫–∞ –µ—Å–ª–∏ –∞–≤—Ç–æ–ø–ª–µ–π –∑–∞–±–ª–æ—á–µ–Ω */
        
        video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        
        #status { font-size: 14px; color: #aaa; margin-top: 5px; }
        input { background: #222; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; width: 220px; text-align: center; margin-top: 5px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="controls">
        <div id="ui-start">
            <h3>üöÄ –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é</h3>
            <button class="btn-start" onclick="startStream()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>

        <div id="ui-stream" class="hidden">
            <div id="status">–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞. –ñ–¥–µ–º –¥—Ä—É–≥–∞...</div>
            <input type="text" id="share-link" readonly onclick="this.select()">
            <br>
            <button class="btn-copy" onclick="copyLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>

        <div id="ui-viewer" class="hidden">
            <h3>üëÅ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</h3>
            <p id="view-status">–°–æ–µ–¥–∏–Ω—è–µ–º—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...</p>
            <button id="play-btn" class="btn-play" onclick="forcePlay()">‚ñ∂ –í–ö–õ–Æ–ß–ò–¢–¨ –ó–í–£–ö –ò –í–ò–î–ï–û</button>
        </div>
    </div>

    <video id="video-player" autoplay playsinline controls></video>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å STUN —Å–µ—Ä–≤–µ—Ä–∞–º–∏ (–ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–±–∏—Ç—å NAT)
        const peerConfig = {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const hostIdFromUrl = urlParams.get('id');
        const videoElem = document.getElementById('video-player');
        let peer;
        let localStream;

        // === –°–¶–ï–ù–ê–†–ò–ô –ó–†–ò–¢–ï–õ–Ø ===
        if (hostIdFromUrl) {
            document.getElementById('ui-start').classList.add('hidden');
            document.getElementById('ui-viewer').classList.remove('hidden');
            initViewer(hostIdFromUrl);
        }

        // === –õ–û–ì–ò–ö–ê –•–û–°–¢–ê ===
        async function startStream() {
            try {
                // –ó–∞—Ö–≤–∞—Ç
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always", frameRate: 60 },
                    audio: {
                        echoCancellation: false, 
                        noiseSuppression: false,
                        autoGainControl: false 
                    }
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–±–µ (–±–µ–∑ –∑–≤—É–∫–∞)
                videoElem.srcObject = localStream;
                videoElem.muted = true;

                // –°–æ–∑–¥–∞–µ–º Peer
                peer = new Peer(null, peerConfig);

                peer.on('open', (id) => {
                    const shareUrl = location.origin + location.pathname + '?id=' + id;
                    document.getElementById('ui-start').classList.add('hidden');
                    document.getElementById('ui-stream').classList.remove('hidden');
                    document.getElementById('share-link').value = shareUrl;
                });

                // –•–ò–¢–†–û–°–¢–¨: –í–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–Ω–∏—è –∑–≤–æ–Ω–∫–∞, –º—ã –∂–¥–µ–º DATA-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç –∑—Ä–∏—Ç–µ–ª—è,
                // –∞ –ø–æ—Ç–æ–º –°–ê–ú–ò –∑–≤–æ–Ω–∏–º –µ–º—É —Å –≤–∏–¥–µ–æ. –≠—Ç–æ –Ω–∞–¥–µ–∂–Ω–µ–µ.
                peer.on('connection', (conn) => {
                    conn.on('open', () => {
                        document.getElementById('status').innerText = "–î—Ä—É–≥ –Ω–∞ —Å–≤—è–∑–∏! –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ç–æ–∫...";
                        // –ó–≤–æ–Ω–∏–º –¥—Ä—É–≥—É
                        const call = peer.call(conn.peer, localStream);
                    });
                });

                // –ï—Å–ª–∏ —Å—Ç—Ä–∏–º –≤—ã–∫–ª—é—á–∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω–æ
                localStream.getVideoTracks()[0].onended = () => location.reload();

            } catch (err) {
                alert("–û—à–∏–±–∫–∞: " + err.message);
            }
        }

        function copyLink() {
            const copyText = document.getElementById("share-link");
            copyText.select();
            document.execCommand("copy");
            alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
        }

        // === –õ–û–ì–ò–ö–ê –ó–†–ò–¢–ï–õ–Ø ===
        function initViewer(hostId) {
            peer = new Peer(null, peerConfig);

            peer.on('open', (myId) => {
                document.getElementById('view-status').innerText = "–°—Ç—É—á–∏–º—Å—è –∫ —Ö–æ—Å—Ç—É...";
                
                // 1. –ü—Ä–æ—Å—Ç–æ —Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è (DataConnection), —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å —Å–≤–æ–π ID
                const conn = peer.connect(hostId);
                
                conn.on('open', () => {
                    document.getElementById('view-status').innerText = "–°–æ–µ–¥–∏–Ω–µ–Ω–æ! –ñ–¥–µ–º –≤–∏–¥–µ–æ...";
                });
            });

            // 2. –ñ–¥–µ–º –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ –æ—Ç –•–æ—Å—Ç–∞
            peer.on('call', (call) => {
                document.getElementById('view-status').innerText = "–ü—Ä–∏–Ω–∏–º–∞–µ–º –ø–æ—Ç–æ–∫...";
                call.answer(); // –û—Ç–≤–µ—á–∞–µ–º
                
                call.on('stream', (remoteStream) => {
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    document.getElementById('controls').classList.add('hidden');
                    
                    videoElem.srcObject = remoteStream;
                    videoElem.muted = false;

                    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                    const playPromise = videoElem.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            // –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∞–≤—Ç–æ–ø–ª–µ–π
                            document.getElementById('controls').classList.remove('hidden');
                            document.getElementById('ui-viewer').classList.add('hidden');
                            document.getElementById('play-btn').style.display = 'block';
                            document.getElementById('play-btn').innerText = "‚ö† –ù–ê–ñ–ú–ò –°–Æ–î–ê, –ß–¢–û–ë–´ –°–ú–û–¢–†–ï–¢–¨";
                        });
                    }
                });
            });

            peer.on('error', (err) => {
                document.getElementById('view-status').innerText = "–û—à–∏–±–∫–∞: " + err.type;
                console.error(err);
            });
        }

        function forcePlay() {
            videoElem.play();
            document.getElementById('controls').classList.add('hidden');
        }
    </script>
</body>
</html>
