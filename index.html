<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моя Видеостудия</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #2c2f33; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
            padding: 20px; 
        }
        h1 { margin-bottom: 20px; }
        .dashboard {
            background: #23272a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        input {
            padding: 10px;
            border-radius: 4px;
            border: none;
            width: 200px;
        }
        button {
            padding: 10px 20px;
            background-color: #7289da;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background-color: #5b6eae; }
        #my-id { font-weight: bold; color: #43b581; user-select: all; cursor: pointer;}
        .video-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        video {
            width: 400px;
            height: 300px;
            background-color: #000;
            border-radius: 8px;
            border: 2px solid #7289da;
            object-fit: cover;
        }
    </style>
</head>
<body>

    <h1>Студия Связи</h1>

    <div class="dashboard">
        <p>Твой ID (отправь другу): <span id="my-id" title="Нажми, чтобы скопировать">Загрузка...</span></p>
        <div>
            <input type="text" id="remote-id" placeholder="Вставь ID друга">
            <button onclick="makeCall()">Позвонить</button>
        </div>
    </div>

    <div class="video-container">
        <div>
            <h3>Ты</h3>
            <video id="my-video" autoplay muted playsinline></video>
        </div>
        <div>
            <h3>Собеседник</h3>
            <video id="friend-video" autoplay playsinline></video>
        </div>
    </div>

    <script>
        // Инициализация
        const peer = new Peer();
        let myStream;

        // 1. Получаем доступ к камере и микрофону сразу при входе
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                myStream = stream;
                const myVideo = document.getElementById('my-video');
                myVideo.srcObject = stream;

                // Настраиваем прием звонков
                peer.on('call', call => {
                    // Отвечаем на звонок своим потоком
                    call.answer(stream); 
                    const video = document.getElementById('friend-video');
                    
                    call.on('stream', userVideoStream => {
                        video.srcObject = userVideoStream;
                    });
                });
            })
            .catch(err => {
                alert('Ошибка доступа к камере: ' + err);
            });

        // 2. Показываем свой ID
        peer.on('open', id => {
            const idSpan = document.getElementById('my-id');
            idSpan.innerText = id;
            idSpan.onclick = () => {
                navigator.clipboard.writeText(id);
                alert('ID скопирован!');
            };
        });

        // 3. Функция звонка другу
        function makeCall() {
            const remoteId = document.getElementById('remote-id').value;
            if (!remoteId) return alert('Введите ID друга!');

            const call = peer.call(remoteId, myStream);
            const video = document.getElementById('friend-video');

            call.on('stream', userVideoStream => {
                video.srcObject = userVideoStream;
            });
        }
    </script>
</body>
</html>
